# Taken from https://awesome-prometheus-alerts.grep.to/rules



groups:
- name: Mysql
  rules:

  - alert: MysqlDown
    expr: mysql_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "MySQL down (instance {{ $labels.instance }})"
      description: "MySQL instance is down on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlTooManyConnections
    expr: avg by (instance) (max_over_time(mysql_global_status_threads_connected[5m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 > 80
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "MySQL too many connections (instance {{ $labels.instance }})"
      description: "More than 80% of MySQL connections are in use on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlHighThreadsRunning
    expr: avg by (instance) (max_over_time(mysql_global_status_threads_running[5m])) / avg by (instance) (mysql_global_variables_max_connections) * 100 > 60
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "MySQL high threads running (instance {{ $labels.instance }})"
      description: "More than 60% of MySQL connections are in running state on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlSlaveIoThreadNotRunning
    expr: mysql_slave_status_master_server_id > 0 and ON (instance) mysql_slave_status_slave_io_running == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "MySQL Slave IO thread not running (instance {{ $labels.instance }})"
      description: "MySQL Slave IO thread not running on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlSlaveSqlThreadNotRunning
    expr: mysql_slave_status_master_server_id > 0 and ON (instance) mysql_slave_status_slave_sql_running == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "MySQL Slave SQL thread not running (instance {{ $labels.instance }})"
      description: "MySQL Slave SQL thread not running on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlSlaveReplicationLag
    expr: mysql_slave_status_master_server_id > 0 and ON (instance) (mysql_slave_status_seconds_behind_master - mysql_slave_status_sql_delay) > 300
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "MySQL Slave replication lag (instance {{ $labels.instance }})"
      description: "MysqL replication lag on {{ $labels.instance }}\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlSlowQueries
    expr: rate(mysql_global_status_slow_queries[5m]) > 0
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "MySQL slow queries (instance {{ $labels.instance }})"
      description: "MySQL server is having some slow queries.\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: MysqlRestarted
    expr: mysql_global_status_uptime < 60
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "MySQL restarted (instance {{ $labels.instance }})"
      description: "MySQL has just been restarted, less than one minute ago on {{ $labels.instance }}.\n  VALUE = {{ $value }}\n  LABELS: {{ $labels }}"

  - alert: mariadb_innodb_replication_fallen_behind
    expr: (mysql_global_variables_innodb_replication_delay > 30) and ON(instance) (predict_linear(mysql_global_variables_innodb_replication_delay[5m], 60 * 2) > 0)
    for: 10m
    labels:
      severity: warning
    annotations:
      description: "MySQL innodb replication is lagging on host {{ $labels.host_name }}"

  - alert: MysqlInnodbLogWaits
    expr: rate(mysql_global_status_innodb_log_waits[15m]) > 10
    for: 1m
    labels:
      severity: warning
    annotations:
      description: "Writing the InnoDB logs is too slow on {{ $labels.host_name }}."
      message: "MySQL InnoDB log waits on Host {{ $labels.host_name }}"

  - alert: mariadb_table_lock_wait_high
    expr: 100 * mysql_global_status_table_locks_waited / (mysql_global_status_table_locks_waited + mysql_global_status_table_locks_immediate) > 30
    for: 10m
    labels:
      severity: warning
    annotations:
      description: "Mariadb hat hohe Table Lock Waits."
      message: "Mariadb table lock waits are high on host {{ $labels.host_name }}"

  - alert: mariadb_node_not_ready
    expr: mysql_global_status_wsrep_ready != 1
    for: 10m
    labels:
      severity: warning
    annotations:
      description: "{{$labels.job}} is not ready on host {{ $labels.host_name }}."
      message: "Galera cluster node not ready on host {{ $labels.host_name }}"

  - alert: mariadb_galera_node_out_of_sync
    expr: mysql_global_status_wsrep_local_state != 4 and mysql_global_variables_wsrep_desync == 0
    for: 10m
    labels:
      severity: warning
    annotations:
      description: "{{$labels.job}} on {{$labels.instance}} ist out of sync."
      message: "Galera cluster node out of sync on host {{ $labels.host_name }}"

  - alert: mariadb_innodb_replication_fallen_behind
    expr: (mysql_global_variables_innodb_replication_delay > 30) and ON(instance) (predict_linear(mysql_global_variables_innodb_replication_delay[5m], 60 * 2) > 0)
    for: 10m
    labels:
      severity: warning
    annotations:
      description: "MySQL InnoDB replication is running too slow on host {{ $labels.host_name }} and hasn't gotten faster for 10 minutes."
      message: "MySQL innodb replication is lagging on host {{ $labels.host_name }}"